services:
  # ==========================================
  # POSTGRESQL 16
  # ==========================================
  postgres:
    image: postgres:16-alpine
    container_name: taaf_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: taaf_user
      POSTGRES_PASSWORD: taaf_secure_password_2024
      POSTGRES_DB: gitlab
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
      - ./scripts/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh
    networks:
      - taaf_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taaf_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # GITLAB
  # ==========================================
  gitlab:
    image: gitlab/gitlab-ce:latest
    container_name: taaf_gitlab
    restart: unless-stopped
    hostname: git.taaf.internal
    depends_on:
      - postgres
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://git.taaf.internal'
        gitlab_rails['initial_root_password'] = 'TAAFAdmin2024!'

        postgresql['enable'] = false
        gitlab_rails['db_adapter'] = 'postgresql'
        gitlab_rails['db_encoding'] = 'utf8'
        gitlab_rails['db_host'] = 'postgres'
        gitlab_rails['db_port'] = 5432
        gitlab_rails['db_database'] = 'gitlab'
        gitlab_rails['db_username'] = 'taaf_user'
        gitlab_rails['db_password'] = 'taaf_secure_password_2024'

        prometheus_monitoring['enable'] = false

        nginx['listen_port'] = 80
        nginx['listen_https'] = false
    ports:
      - "2222:22"
    volumes:
      - ./data/gitlab/config:/etc/gitlab
      - ./data/gitlab/data:/var/opt/gitlab
      - ./data/gitlab/logs:/var/log/gitlab
    networks:
      - taaf_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/-/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 300s

  # ==========================================
  # NEXTCLOUD
  # ==========================================
  nextcloud_db:
    image: postgres:15-alpine
    container_name: taaf_nextcloud_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: nextcloud_user
      POSTGRES_PASSWORD: nextcloud_secure_2024
      POSTGRES_DB: nextcloud
    volumes:
      - ./data/nextcloud/db:/var/lib/postgresql/data
    networks:
      - taaf_network

  nextcloud:
    image: nextcloud:latest
    container_name: taaf_nextcloud
    restart: unless-stopped
    depends_on:
      - nextcloud_db
    environment:
      POSTGRES_HOST: nextcloud_db
      POSTGRES_DB: nextcloud
      POSTGRES_USER: nextcloud_user
      POSTGRES_PASSWORD: nextcloud_secure_2024
      NEXTCLOUD_ADMIN_USER: admin
      NEXTCLOUD_ADMIN_PASSWORD: TAAFCloud2024!
      NEXTCLOUD_TRUSTED_DOMAINS: cloud.taaf.internal
      OVERWRITEPROTOCOL: http
      OVERWRITEHOST: cloud.taaf.internal
    volumes:
      - ./data/nextcloud/html:/var/www/html
      - ./data/nextcloud/data:/var/www/html/data
      #- ./data/nextcloud/config:/var/www/html/config
    networks:
      - taaf_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3


  # ==========================================
  # MATTERMOST
  # ==========================================
  mattermost_db:
    image: postgres:15-alpine
    container_name: taaf_mattermost_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: mattermost
      POSTGRES_USER: mattermost_user
      POSTGRES_PASSWORD: mattermost_secure_2024
    volumes:
      - ./data/mattermost/db:/var/lib/postgresql/data
    networks:
      - taaf_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mattermost_user -d mattermost"]
      interval: 10s
      timeout: 5s
      retries: 5

  mattermost:
    image: mattermost/mattermost-team-edition:latest
    container_name: taaf_mattermost
    restart: unless-stopped
    depends_on:
      mattermost_db:
        condition: service_healthy
    environment:
      MM_SQLSETTINGS_DRIVERNAME: postgres
      MM_SQLSETTINGS_DATASOURCE: postgres://mattermost_user:mattermost_secure_2024@mattermost_db:5432/mattermost?sslmode=disable&connect_timeout=10
      MM_SERVICESETTINGS_SITEURL: http://chat.taaf.internal
      MM_SERVICESETTINGS_ENABLELOCALMODE: "true"
      TZ: Indian/Reunion

      # === Admin Mattermost par défaut ===
      MM_ADMIN_USERNAME: admin
      MM_ADMIN_EMAIL: admin@taaf.internal
      MM_ADMIN_PASSWORD: TAAFAdmin2025!

      # === SMTP MailHog pour tests ===
      MM_EMAILSETTINGS_ENABLESMTP: "true"
      MM_EMAILSETTINGS_SMTPUSERNAME: ""
      MM_EMAILSETTINGS_SMTPPASSWORD: ""
      MM_EMAILSETTINGS_SMTPSERVER: mailhog
      MM_EMAILSETTINGS_SMTPPORT: "1025"
      MM_EMAILSETTINGS_SENDERADDRESS: "noreply@taaf.internal"
      MM_EMAILSETTINGS_SENDPASSWORDRESETEMAIL: "true"
      MM_EMAILSETTINGS_NOTIFYPROPERTIESCHANGED: "true"

    volumes:
      - ./data/mattermost/config:/mattermost/config
      - ./data/mattermost/data:/mattermost/data
      - ./data/mattermost/logs:/mattermost/logs
      - ./data/mattermost/plugins:/mattermost/plugins
      - ./data/mattermost/client-plugins:/mattermost/client/plugins
    networks:
      - taaf_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8065/api/v4/system/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================
  # MAILHOG (SMTP pour Mattermost)
  # ==========================================
  mailhog:
    image: mailhog/mailhog
    container_name: taaf_mailhog
    restart: unless-stopped
    ports:
      - "8025:8025"   # interface web
      - "1025:1025"   # SMTP
    networks:
      - taaf_network

  # ==========================================
  # KEYCLOAK
  # ==========================================
  keycloak:
    image: quay.io/keycloak/keycloak:latest
    container_name: taaf_keycloak
    restart: unless-stopped
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: TAAFKeycloak2024!
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://taaf_postgres:5432/keycloak
      KC_DB_USERNAME: taaf_user
      KC_DB_PASSWORD: taaf_secure_password_2024
      KC_HOSTNAME: 192.168.50.139
      KC_HOSTNAME_PORT: 8080
      KC_HOSTNAME_STRICT: "false"
      KC_HTTP_ENABLED: "true"
      KC_PROXY: edge
    ports:
      - "8080:8080"
      - "8443:8443"
    volumes:
      - ./data/keycloak:/opt/keycloak/data
    networks:
      - taaf_network
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ==========================================
  # CADDY
  # ==========================================
  caddy:
    image: caddy:2-alpine
    container_name: taaf_caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./data/caddy/data:/data
      - ./data/caddy/config:/config
      - ./caddy/portal:/srv/portal
    networks:
      - taaf_network
    depends_on:
      - gitlab
      - nextcloud
      - mattermost
    healthcheck:
      test: ["CMD", "caddy", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
  # Webhook GitLab vers Mattermost
  gitlab-webhook:
    build:
      context: ./scripts/webhooks
      dockerfile: Dockerfile
    container_name: taaf_gitlab_webhook
    environment:
      - MATTERMOST_WEBHOOK_URL=http://mattermost:8065/hooks/8jomgg6xy3gkzn9btb1y6oanhc
    networks:
      - taaf_network
    restart: unless-stopped

  # Monitoring Nextcloud vers Mattermost
  nextcloud-monitor:
    build:
      context: ./scripts/webhooks
      dockerfile: Dockerfile.monitor
    container_name: taaf_nextcloud_monitor
    environment:
      - WATCH_PATH=/nextcloud-data/admin/files/Documents-RH
      - MATTERMOST_WEBHOOK_URL=http://mattermost:8065/hooks/zgq58agzebnyxp78xsgyfb9p8a
    volumes:
      - ./data/nextcloud/data:/nextcloud-data:ro
    networks:
      - taaf_network
    restart: unless-stopped
    depends_on:
      - nextcloud
      - mattermost
# ==========================================
# RÉSEAU
# ==========================================
networks:
  taaf_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
